services:
    mysql:
        image: mysql:8.0
        environment:
            MYSQL_ROOT_PASSWORD: root_password
            MYSQL_DATABASE: mcp_test
            MYSQL_USER: test_user
            MYSQL_PASSWORD: test_password
        ports:
            - "13306:3306"
        healthcheck:
            test:
                [
                    "CMD",
                    "mysqladmin",
                    "ping",
                    "-h",
                    "localhost",
                    "-u",
                    "test_user",
                    "-ptest_password",
                ]
            interval: 5s
            timeout: 3s
            retries: 10
            start_period: 10s

    postgres:
        image: postgres:16
        environment:
            POSTGRES_DB: mcp_test
            POSTGRES_USER: test_user
            POSTGRES_PASSWORD: test_password
        ports:
            - "15432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U test_user -d mcp_test"]
            interval: 5s
            timeout: 3s
            retries: 10
            start_period: 10s

    sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        environment:
            ACCEPT_EULA: "Y"
            SA_PASSWORD: "Test@Password123"
            MSSQL_PID: "Developer"
        ports:
            - "11433:1433"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P 'Test@Password123' -Q \"IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'mcp_test') BEGIN CREATE DATABASE mcp_test END\" && /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P 'Test@Password123' -d mcp_test -Q 'SELECT 1' || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s

    php-test:
        build:
            context: .
            dockerfile: Dockerfile.test
        volumes:
            - .:/app
            - huggingface-cache:/huggingface-cache
        environment:
            - APP_ENV=test
            - DATABASE_CONFIG_FILE=databases.test.yaml
            - POSTGRES_DSN=postgresql://test_user:test_password@postgres:5432/mcp_test
            - HF_HOME=/huggingface-cache
        depends_on:
            mysql:
                condition: service_healthy
            postgres:
                condition: service_healthy
            sqlserver:
                condition: service_healthy

volumes:
    huggingface-cache:
        name: mcp-huggingface-cache
